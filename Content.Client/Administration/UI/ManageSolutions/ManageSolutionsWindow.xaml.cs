using Content.Shared.Chemistry.Components.SolutionManager;
using Robust.Client.AutoGenerated;
using Robust.Client.Console;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.CustomControls;
using Robust.Client.UserInterface.XAML;
using Robust.Shared.GameObjects;
using Robust.Shared.IoC;
using Robust.Shared.Prototypes;

namespace Content.Client.Administration.UI.ManageSolutions
{
    [GenerateTypedNameReferences]
    public sealed partial class ManageSolutionsWindow : SS14Window
    {
        [Dependency] private readonly IPrototypeManager _prototypeManager = default!;
        [Dependency] private readonly IClientConsoleHost _consoleHost = default!;
        [Dependency] private readonly IEntityManager _entityManager = default!;

        private readonly EntityUid _target;
        private string? _selectedSolution;
        private AddReagentWindow? _addReagentWindow;

        public ManageSolutionsWindow(EntityUid target)
        {
            IoCManager.InjectDependencies(this);
            RobustXamlLoader.Load(this);

            _target = target;

            SolutionOption.OnItemSelected += SolutionSelected;
            AddButton.OnPressed += OpenAddReagentWindow;

            UpdateSolutions();
        }

        private void OpenAddReagentWindow(BaseButton.ButtonEventArgs obj)
        {
            if (string.IsNullOrEmpty(_selectedSolution))
                return;

            _addReagentWindow?.Close();
            _addReagentWindow?.Dispose();

            _addReagentWindow = new AddReagentWindow(_target, _selectedSolution);
            _addReagentWindow.OpenCentered();
        }

        private void SolutionSelected(OptionButton.ItemSelectedEventArgs obj)
        {
            _selectedSolution = (string?) SolutionOption.SelectedMetadata;
            _addReagentWindow?.Close();
            _addReagentWindow?.Dispose();
        }

        private void UpdateSolutions()
        {
            SolutionOption.Clear();
            if (_entityManager.TryGetComponent(_target, out SolutionContainerManagerComponent manager))
            {
                int i = 0;
                foreach (var solution in manager.Solutions.Keys)
                {
                    SolutionOption.AddItem(solution, i );
                    SolutionOption.SetItemMetadata(i, solution);
                    i++;
                }
            }

            if (SolutionOption.ItemCount == 0)
            {
                // No applicable solutions
                Close();
                Dispose();
            }

            SolutionOption.Select(0);
            _selectedSolution = (string?) SolutionOption.SelectedMetadata;
        }
    }
}
