using System.Linq;
using Content.Shared.Administration.Notes;
using Robust.Client.AutoGenerated;
using Robust.Client.UserInterface;
using Robust.Client.UserInterface.XAML;
using static Robust.Client.UserInterface.Controls.LineEdit;

namespace Content.Client.Administration.UI.Notes;

[GenerateTypedNameReferences]
public sealed partial class AdminNotesControl : Control
{
    [Dependency] private readonly IUserInterfaceManager _ui = default!;

    public event Action<int, string>? OnNoteChanged;
    public event Action<string>? OnNewNoteEntered;
    public event Action<int>? OnNoteDeleted;

    private readonly Dictionary<int, AdminNotesLine> _inputs = new();

    private AdminNotesLinePopup? _popup;

    public AdminNotesControl()
    {
        RobustXamlLoader.Load(this);
        IoCManager.InjectDependencies(this);

        NewNote.OnTextEntered += NewNoteEntered;
    }

    private void NewNoteEntered(LineEditEventArgs args)
    {
        if (string.IsNullOrWhiteSpace(args.Text))
        {
            return;
        }

        NewNote.Clear();
        OnNewNoteEntered?.Invoke(args.Text);
    }

    private void NoteSubmitted(AdminNotesLine input)
    {
        var text = input.EditText.Trim();
        if (input.OriginalMessage == text)
        {
            return;
        }

        OnNoteChanged?.Invoke(input.Id, text);
    }

    private bool NoteRightClicked(AdminNotesLine line)
    {
        ClosePopup();

        _popup = new AdminNotesLinePopup(line.Note);
        _popup.OnEditPressed += noteId =>
        {
            if (!_inputs.TryGetValue(noteId, out var input))
            {
                return;
            }

            input.SetEditable(true);
        };
        _popup.OnDeletePressed += noteId => OnNoteDeleted?.Invoke(noteId);

        var box = UIBox2.FromDimensions(_ui.MousePositionScaled.Position, (1, 1));
        _popup.Open(box);

        return true;
    }

    private void ClosePopup()
    {
        if (_popup == null)
        {
            return;
        }

        _popup.Close();
        _popup = null;
    }

    public void SetNotes(Dictionary<int, SharedAdminNote> notes)
    {
        foreach (var (id, input) in _inputs)
        {
            if (!notes.ContainsKey(id))
            {
                Notes.RemoveChild(input);
                _inputs.Remove(id);
            }
        }

        foreach (var note in notes.Values.OrderBy(note => note.Id))
        {
            if (_inputs.TryGetValue(note.Id, out var input))
            {
                input.UpdateNote(note);
                continue;
            }

            input = new AdminNotesLine(note);
            input.OnSubmitted += NoteSubmitted;
            input.OnRightClicked += NoteRightClicked;
            Notes.AddChild(input);
            _inputs[note.Id] = input;
        }
    }

    protected override void Dispose(bool disposing)
    {
        base.Dispose(disposing);

        if (!disposing)
        {
            return;
        }

        foreach (var input in _inputs.Values)
        {
            input.OnSubmitted -= NoteSubmitted;
        }

        _inputs.Clear();
        NewNote.OnTextEntered -= NewNoteEntered;

        if (_popup != null)
        {
            _ui.PopupRoot.RemoveChild(_popup);
        }

        OnNoteChanged = null;
        OnNewNoteEntered = null;
        OnNoteDeleted = null;
    }
}
