using Content.Client.Message;
using Content.Client.UserInterface.Controls;
using Content.Shared.Access.Systems;
using Content.Shared.CriminalRecords;
using Content.Shared.Security;
using Content.Shared.StationRecords;
using Robust.Client.AutoGenerated;
using Robust.Client.Player;
using Robust.Client.UserInterface;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.XAML;

namespace Content.Client.CriminalRecords;

// TODO: dedupe shitcode from general records theres a lot
[GenerateTypedNameReferences]
public sealed partial class CriminalRecordsConsoleWindow : FancyWindow
{
    [Dependency] private readonly IEntityManager _entity = default!;
    [Dependency] private readonly IPlayerManager _player = default!;
    private readonly AccessReaderSystem _accessReader;

    public readonly EntityUid Console;

    public Action<uint?>? OnKeySelected;
    public Action<StationRecordFilterType, string>? OnFiltersChanged;
    public Action<BaseButton.ButtonEventArgs, string, string>? OnArrestButtonPressed;
    public Action<OptionButton.ItemSelectedEventArgs, SecurityStatus, string, string>? OnStatusOptionButtonSelected;
    public Action<BaseButton.ButtonEventArgs, string>? OnAddHistoryPressed;
    public Action<BaseButton.ButtonEventArgs, uint>? OnDeleteHistoryPressed;

    private bool _isPopulating;
    private string _recordName = string.Empty;
    private uint? _historyIndex;

    private StationRecordFilterType _currentFilterType;

    public CriminalRecordsConsoleWindow(EntityUid console)
    {
        RobustXamlLoader.Load(this);
        IoCManager.InjectDependencies(this);

        _accessReader = _entity.System<AccessReaderSystem>();
        Console = console;

        _currentFilterType = StationRecordFilterType.Name;

        foreach (var item in Enum.GetValues<StationRecordFilterType>())
        {
            StationRecordsFilterType.AddItem(GetTypeFilterLocals(item), (int)item);
        }

        RecordListing.OnItemSelected += args =>
        {
            if (_isPopulating || RecordListing[args.ItemIndex].Metadata is not uint cast)
                return;

            OnKeySelected?.Invoke(cast);
        };

        RecordListing.OnItemDeselected += _ =>
        {
            if (!_isPopulating)
                OnKeySelected?.Invoke(null);
        };

        StationRecordsFilterType.OnItemSelected += eventArgs =>
        {
            var type = (StationRecordFilterType)eventArgs.Id;

            if (_currentFilterType != type)
            {
                _currentFilterType = type;
                FilterListingOfRecords();
            }
        };

        StationRecordsFiltersValue.OnTextEntered += args =>
        {
            FilterListingOfRecords(args.Text);
        };

        StationRecordsFilters.OnPressed += _ =>
        {
            FilterListingOfRecords(StationRecordsFiltersValue.Text);
        };

        StationRecordsFiltersReset.OnPressed += _ =>
        {
            StationRecordsFiltersValue.Text = "";
            FilterListingOfRecords();
        };

        ArrestButton.OnPressed += e => OnArrestButtonPressed?.Invoke(e, ReasonLineEdit.Text, _recordName);

        StatusOptionButton.OnItemSelected += args =>
        {
            args.Button.SelectId(args.Id);
            OnStatusOptionButtonSelected?.Invoke(args, (SecurityStatus) StatusOptionButton.GetItemMetadata(args.Id)!,
                ReasonLineEdit.Text, _recordName);
        };

        AddHistoryButton.OnPressed += e =>
        {
            if (!string.IsNullOrEmpty(HistoryLineEdit.Text))
            {
                OnAddHistoryPressed?.Invoke(e, HistoryLineEdit.Text);
                HistoryLineEdit.Clear();
                // adding deselects so prevent deleting yeah
                _historyIndex = null;
                DeleteHistoryButton.Disabled = true;
            }
        };
        DeleteHistoryButton.OnPressed += e =>
        {
            if (_historyIndex is {} index)
            {
                OnDeleteHistoryPressed?.Invoke(e, index);
                // prevent total spam wiping
                History.ClearSelected();
                _historyIndex = null;
                DeleteHistoryButton.Disabled = true;
            }
        };

        History.OnItemSelected += args =>
        {
            _historyIndex = (uint) args.ItemIndex;
            DeleteHistoryButton.Disabled = false;
        };
        History.OnItemDeselected += args =>
        {
            _historyIndex = null;
            DeleteHistoryButton.Disabled = true;
        };
    }

    public void UpdateState(CriminalRecordsConsoleState state)
    {
        if (state.Filter != null)
        {
            if (state.Filter.Type != _currentFilterType)
            {
                _currentFilterType = state.Filter.Type;
            }

            if (state.Filter.Value != StationRecordsFiltersValue.Text)
            {
                StationRecordsFiltersValue.Text = state.Filter.Value;
            }
        }

        StationRecordsFilterType.SelectId((int)_currentFilterType);

        if (state.RecordListing == null)
        {
            PersonContainer.Visible = false;
            HistoryContainer.Visible = false;
            return;
        }

        var selected = state.SelectedKey != null;

        PersonContainer.Visible = true;
        HistoryContainer.Visible = selected;

        PopulateRecordListing(state.RecordListing!, state.SelectedKey);

        RecordContainerStatus.Visible = state.CriminalRecord == null;

        var status = state.CriminalRecord?.Status;
        var arrest = status == SecurityStatus.Detained ? "release" : "arrest";
        ArrestButton.Text = Loc.GetString($"criminal-records-{arrest}-button");

        var access = _player.LocalPlayer?.ControlledEntity is not { } player
            || _accessReader.IsAllowed(player, Console);

        // hide access-required editing parts when no access
        var editing = access && selected;
        StatusEditing.Visible = editing;
        HistoryEditing.Visible = editing;

        StatusOptionButton.Disabled = status == SecurityStatus.Detained;

        History.Clear();

        if (state.CriminalRecord != null && state.StationRecord != null)
        {
            if (!StatusOptionButton.Disabled)
            {
                StatusOptionButton.Clear();

                var idNone = AddStatusSelect(SecurityStatus.None);
                if (status == SecurityStatus.None)
                    StatusOptionButton.Select(idNone);

                var idWanted = AddStatusSelect(SecurityStatus.Wanted);
                if (status == SecurityStatus.Wanted)
                    StatusOptionButton.Select(idWanted);
            }
            else
            {
                StatusOptionButton.AddItem(SecurityStatus.Detained.ToString());
            }

            RecordContainerStatus.Visible = !selected;
            RecordContainerStatus.Text = Loc.GetString("criminal-records-console-select-record-info");
            _recordName = state.StationRecord.Name!;
            PopulateRecordContainer(state.StationRecord, state.CriminalRecord);

            foreach (var line in state.CriminalRecord.History)
            {
                History.AddItem(line);
            }
        }
        else
        {
            RecordContainer.DisposeAllChildren();
            RecordContainer.RemoveAllChildren();
        }
    }

    private void PopulateRecordListing(Dictionary<uint, string> listing, uint? selected)
    {
        RecordListing.Clear();
        RecordListing.ClearSelected();

        _isPopulating = true;
        foreach (var (key, name) in listing)
        {
            var item = RecordListing.AddItem(name);
            item.Metadata = key;
            item.Selected = key == selected;
        }
        _isPopulating = false;

        RecordListing.SortItemsByText();
    }

    private void PopulateRecordContainer(GeneralStationRecord stationRecord, CriminalRecord criminalRecord)
    {
        RecordContainer.DisposeAllChildren();
        RecordContainer.RemoveAllChildren();

        var recordControls = new Control[]
        {
            new Label()
            {
                Text = stationRecord.Name,
                StyleClasses = { "LabelBig" }
            },
            new PanelContainer()
            {
                StyleClasses = {"LowDivider"}, Margin = new Thickness(0, 5, 0, 5)
            },
            new RichTextLabel()
                .SetMarkup(Loc.GetString("criminal-records-console-record-status",
                    ("status", criminalRecord.Status.ToString().ToLower())))
        };

        foreach (var control in recordControls)
        {
            RecordContainer.AddChild(control);
        }

        if (criminalRecord.Reason == string.Empty)
            return;

        var label = new RichTextLabel();
        label.SetMessage(criminalRecord.Reason);
        RecordContainer.AddChild(label);
    }

    private int AddStatusSelect(SecurityStatus status)
    {
        StatusOptionButton.AddItem(status.ToString());
        StatusOptionButton.SetItemMetadata(StatusOptionButton.ItemCount - 1, status);
        return StatusOptionButton.ItemCount - 1;
    }

    private void SelectOption(OptionButton.ItemSelectedEventArgs args)
    {
        args.Button.SelectId(args.Id);
        OnStatusOptionButtonSelected?.Invoke(args, (SecurityStatus) StatusOptionButton.GetItemMetadata(args.Id)!,
            ReasonLineEdit.Text, _recordName);
    }

    private void FilterListingOfRecords(string text = "")
    {
        if (!_isPopulating)
        {
            OnFiltersChanged?.Invoke(_currentFilterType, text);
        }
    }

    private string GetTypeFilterLocals(StationRecordFilterType type)
    {
        return Loc.GetString($"criminal-records-{type.ToString().ToLower()}-filter");
    }
}
