using Content.Shared.Damage;
using Content.Shared.Damage.Prototypes;
using Content.Shared.Disease.Components;
using Content.Shared.FixedPoint;
using Content.Shared.IdentityManagement;
using Content.Shared.Chemistry.Components;
using Robust.Client.AutoGenerated;
using Robust.Client.UserInterface.CustomControls;
using Robust.Client.UserInterface.XAML;
using Robust.Shared.Prototypes;
using System.Text;
using static Content.Shared.MedicalScanner.SharedMedicalResearchBedComponent;

namespace Content.Client.MedicalResearchBed.UI
{
    [GenerateTypedNameReferences]
    public sealed partial class MedicalResearchBedWindow : DefaultWindow
    {
        public MedicalResearchBedWindow()
        {
            RobustXamlLoader.Load(this);
        }

        public void Populate(MedicalResearchBedScannedUserMessage msg)
        {
            var text = new StringBuilder();
            var entities = IoCManager.Resolve<IEntityManager>();

            if (msg.BuckledEntity != null && entities.TryGetComponent<DamageableComponent>(msg.BuckledEntity, out var damageable))
            {
                string entityName = "Unknown";
                if (msg.BuckledEntity != null &&
                    entities.TryGetComponent<MetaDataComponent>(msg.BuckledEntity.Value, out var metaData))
                    entityName = Identity.Name(msg.BuckledEntity.Value, entities);

                IReadOnlyDictionary<string, FixedPoint2> DamagePerGroup = damageable.DamagePerGroup;
                IReadOnlyDictionary<string, FixedPoint2> DamagePerType = damageable.Damage.DamageDict;

                text.Append($"{Loc.GetString("health-analyzer-window-damage-total-healed")}\n");
                text.Append(msg.HealthChanges + "\n\n");

                text.Append($"{Loc.GetString("health-analyzer-window-entity-health-text", ("entityName", entityName))}\n");

                /// Status Effects / Components
                if (entities.HasComponent<DiseasedComponent>(msg.BuckledEntity))
                {
                    text.Append($"{Loc.GetString("disease-scanner-diseased")}\n");
                }else
                {
                    text.Append($"{Loc.GetString("disease-scanner-not-diseased")}\n");
                }

                // Unmetabolised reagents in buckled entity
                if (msg.BufferReagents.Count > 0)
                    text.Append($"\n{Loc.GetString("health-analyzer-window-unmetabolised-chems")}\n");

                foreach (var content in (msg.BufferReagents))
                {
                    text.Append("\n" + content.ReagentId + ": " + content.Quantity.ToString() + "u");
                }

                /// Damage
                text.Append($"\n\n{Loc.GetString("health-analyzer-window-entity-damage-total-text", ("amount", damageable.TotalDamage))}\n");

                HashSet<string> shownTypes = new();

                var protos = IoCManager.Resolve<IPrototypeManager>();

                // Show the total damage and type breakdown for each damage group.
                foreach (var (damageGroupId, damageAmount) in DamagePerGroup)
                {
                    text.Append($"\n{Loc.GetString("health-analyzer-window-damage-group-text", ("damageGroup", Loc.GetString("health-analyzer-window-damage-group-" + damageGroupId)), ("amount", damageAmount))}");
                    // Show the damage for each type in that group.
                    var group = protos.Index<DamageGroupPrototype>(damageGroupId);
                    foreach (var type in group.DamageTypes)
                    {
                        if (DamagePerType.TryGetValue(type, out var typeAmount))
                        {
                            // If damage types are allowed to belong to more than one damage group, they may appear twice here. Mark them as duplicate.
                            if (!shownTypes.Contains(type))
                            {
                                shownTypes.Add(type);
                                text.Append($"\n- {Loc.GetString("health-analyzer-window-damage-type-text", ("damageType", Loc.GetString("health-analyzer-window-damage-type-" + type)), ("amount", typeAmount))}");
                            }
                        }
                    }
                    text.AppendLine();
                }
                Diagnostics.Text = text.ToString();
                SetSize = (250, 800);
            }
            else
            {
                Diagnostics.Text = Loc.GetString("health-analyzer-window-no-patient-data-text");
                SetSize = (250, 100);
            }
        }
    }
}
