using Content.Client.Computer;
using Content.Client.UserInterface.Controls;
using Content.Shared.Shuttles.BUIStates;
using Robust.Client.AutoGenerated;
using Robust.Client.UserInterface.XAML;
using Robust.Shared.Timing;

namespace Content.Client.Salvage.UI;

/// <summary>
/// Generic window for offering multiple selections with a timer.
/// </summary>
[GenerateTypedNameReferences]
public sealed partial class OfferingWindow : FancyWindow,
    IComputerWindow<EmergencyConsoleBoundUserInterfaceState>
{
    [Dependency] private readonly IGameTiming _timing = default!;

    public event Action<ushort>? ClaimOption;

    public bool Claimed;
    public TimeSpan NextOffer;
    public TimeSpan Cooldown;

    private ushort _index;

    public OfferingWindow()
    {
        RobustXamlLoader.Load(this);
        IoCManager.InjectDependencies(this);
    }

    public void AddOption(OfferingWindowOption option)
    {
        Container.AddChild(option);
        var indexCopy = _index;

        option.ClaimPressed += args =>
        {
            ClaimOption?.Invoke(indexCopy);
        };

        _index++;
    }

    public void ClearOptions()
    {
        _index = 0;
        Container.DisposeAllChildren();
    }

    public void SetPressed(ushort index)
    {
        Container.Children[0].
    }

    protected override void FrameUpdate(FrameEventArgs args)
    {
        base.FrameUpdate(args);

        if (Claimed)
        {
            NextOfferBar.Value = 0f;
            NextOfferText.Text = "00:00";
            return;
        }

        var remaining = NextOffer - _timing.CurTime;

        if (remaining < TimeSpan.Zero)
        {
            NextOfferBar.Value = 1f;
            NextOfferText.Text = "00:00";
        }
        else
        {
            NextOfferBar.Value = 1f - (float) (remaining / Cooldown);
            NextOfferText.Text = $"{remaining.Minutes:00}:{remaining.Seconds:00}";
        }
    }
}
