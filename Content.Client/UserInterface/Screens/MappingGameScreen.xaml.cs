using Content.Client.Decals;
using Content.Client.Mapping;
using Content.Client.Mapping.Tools;
using Content.Client.Markers;
using Content.Client.NodeContainer;
using Content.Client.SubFloor;
using Content.Client.Viewport;
using Robust.Client.AutoGenerated;
using Robust.Client.UserInterface;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.XAML;
using Robust.Shared.Timing;

namespace Content.Client.UserInterface.Screens;

[GenerateTypedNameReferences]
public sealed partial class MappingGameScreen : UIScreen
{
    [Dependency] private readonly IEntitySystemManager _entSys = default!;
    [Dependency] private readonly ViewportManager _viewportManager = default!;

    private const float MouseZoomSensitivity = 1;

    public Tool? ActiveTool { get; private set; }

    public MappingGameScreen()
    {
        IoCManager.InjectDependencies(this);
        RobustXamlLoader.Load(this);
        AutoscaleMaxResolution = new Vector2i(1080, 770);

        SetAnchorPreset(InnerScreenContainer, LayoutPreset.Wide);
        SetAnchorPreset(ScreenContainer, LayoutPreset.Wide);
        SetAnchorPreset(MainViewport, LayoutPreset.Wide);
        SetAnchorPreset(ViewportContainer, LayoutPreset.Wide);
        BasicSettingsTabs.SetTabTitle(0, "Tool"); // MAGIC AAAAAAA
    }

    protected override void OnLoaded()
    {
        MappingMenu.Menus.Add(new MenuBar.Menu()
        {
            Title = Loc.GetString("mapping-menus-file"),
            Entries =
            {
                new MenuBar.MenuButton()
                {
                    Text = Loc.GetString("mapping-menus-file-new"),
                    OnPressed = OnNewMap
                },
                new MenuBar.MenuButton()
                {
                    Text = Loc.GetString("mapping-menus-file-open"),
                },
                new MenuBar.MenuSeparator(),
                new MenuBar.MenuButton()
                {
                    Text = Loc.GetString("mapping-menus-file-exit-mapping-scene"),
                },
                new MenuBar.MenuButton()
                {
                    Text = Loc.GetString("mapping-menus-file-disconnect"),
                },
                new MenuBar.MenuButton()
                {
                    Text = Loc.GetString("mapping-menus-file-quit"),
                }
            }
        });

        RebuildVisibilityMenu();
        MappingMenu.Menus.Add(VisibilityMenu);
        ActivateTool(typeof(EntityDrawTool));
    }

    protected override void OnUnloaded()
    {
        base.OnUnloaded();
        DeactivateTool();
    }

    private MenuBar.Menu VisibilityMenu = new()
    {
        Title = Loc.GetString("mapping-menus-file-visibility"),
    };

    private bool DecalVisibility
    {
        get => _entSys.GetEntitySystem<DecalSystem>().Visible;
        set => _entSys.GetEntitySystem<DecalSystem>().Visible = value;
    }

    private bool SubfloorVisibility
    {
        get => _entSys.GetEntitySystem<SubFloorHideSystem>().ShowAll;
        set => _entSys.GetEntitySystem<SubFloorHideSystem>().ShowAll = value;
    }

    private bool MarkersVisibility
    {
        get => _entSys.GetEntitySystem<MarkerSystem>().MarkersVisible;
        set => _entSys.GetEntitySystem<MarkerSystem>().MarkersVisible = value;
    }

    private bool NodeVisVisibility
    {
        get => _entSys.GetEntitySystem<NodeGroupSystem>().VisEnabled;
        set => _entSys.GetEntitySystem<NodeGroupSystem>().SetVisEnabled(value);
    }

    private void RebuildVisibilityMenu()
    {
        VisibilityMenu.Entries.Clear();
        VisibilityMenu.Entries.Add(new MenuBar.MenuButton()
        {
            Text = Loc.GetString("mapping-menus-visibility-markers", ("value", MarkersVisibility)),
            OnPressed = () =>
            {
                MarkersVisibility ^= true;
                RebuildVisibilityMenu();
            }
        });

        VisibilityMenu.Entries.Add(new MenuBar.MenuButton()
        {
            Text = Loc.GetString("mapping-menus-visibility-subfloor", ("value", SubfloorVisibility)),
            OnPressed = () =>
            {
                SubfloorVisibility ^= true;
                RebuildVisibilityMenu();
            }
        });

        VisibilityMenu.Entries.Add(new MenuBar.MenuButton()
        {
            Text = Loc.GetString("mapping-menus-visibility-decals", ("value", DecalVisibility)),
            OnPressed = () =>
            {
                DecalVisibility ^= true;
                RebuildVisibilityMenu();
            }
        });

        VisibilityMenu.Entries.Add(new MenuBar.MenuSeparator());

        VisibilityMenu.Entries.Add(new MenuBar.MenuButton()
        {
            Text = Loc.GetString("mapping-menus-visibility-nodevis", ("value", NodeVisVisibility)),
            OnPressed = () =>
            {
                NodeVisVisibility ^= true;
                RebuildVisibilityMenu();
            }
        });
    }

    private void OnNewMap()
    {
        throw new NotImplementedException();
    }

    protected override void FrameUpdate(FrameEventArgs args)
    {
        base.FrameUpdate(args);
        ActiveTool?.FrameUpdate(args.DeltaSeconds);
    }
}
