#nullable enable

using System.Collections.Generic;
using Content.Shared.Administration.AdminMenu;
using Robust.Client.AutoGenerated;
using Robust.Client.Graphics;
using Robust.Client.Player;
using Robust.Client.UserInterface;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.XAML;
using Robust.Shared.IoC;
using Robust.Shared.Maths;

namespace Content.Client.UserInterface.AdminMenu.Tabs
{
    [GenerateTypedNameReferences]
    public partial class TicketTab : Control
    {
        public delegate void TicketListRefresh();

        public event TicketListRefresh? OnTicketListRefresh;

        public TicketTab()
        {
            IoCManager.InjectDependencies(this);
            RobustXamlLoader.Load(this);
            RefreshButton.OnPressed += (_) => OnTicketListRefresh?.Invoke();
        }

        protected override void EnteredTree()
        {
            OnTicketListRefresh?.Invoke();
        }

        public void RefreshTicketList(IEnumerable<AdminMenuTicketListMessage.TicketInfo> tickets)
        {
            TicketList.RemoveAllChildren();

            var altColor = Color.FromHex("#292B38");
            var defaultColor = Color.FromHex("#2F2F3B");

            var header = new HBoxContainer
            {
                HorizontalExpand = true,
                SeparationOverride = 4,
                Children =
                {
                    new Label
                    {
                        Text = "Id",
                        SizeFlagsStretchRatio = 2f,
                        HorizontalExpand = true
                    },
                    new TicketTab.VSeparator(),
                    new Label
                    {
                        Text = "Name",
                        SizeFlagsStretchRatio = 2f,
                        HorizontalExpand = true
                    },
                    new TicketTab.VSeparator(),
                    new Label()
                    {
                        Text = "Claimed",
                        SizeFlagsStretchRatio = 2f,
                        HorizontalExpand = true,
                    },
                    new TicketTab.VSeparator(),
                    new Label()
                    {
                        Text = "Message",
                        SizeFlagsStretchRatio = 2f,
                        HorizontalExpand = true,
                    }
                }
            };
            TicketList.AddChild(new PanelContainer
            {
                PanelOverride = new StyleBoxFlat
                {
                    BackgroundColor = altColor,
                },
                Children =
                {
                    header
                }
            });
            TicketList.AddChild(new TicketTab.HSeparator());

            var useAltColor = false;
            foreach (var ticket in tickets)
            {
                var hBox = new HBoxContainer
                {
                    HorizontalExpand = true,
                    SeparationOverride = 4,
                    Children =
                    {
                        new Label
                        {
                            Text = ticket.Id.ToString(),
                            SizeFlagsStretchRatio = 2f,
                            HorizontalExpand = true,
                            ClipText = true
                        },
                        new TicketTab.VSeparator(),
                        new Label
                        {
                            Text = ticket.Name,
                            SizeFlagsStretchRatio = 2f,
                            HorizontalExpand = true,
                            ClipText = true
                        },
                        new TicketTab.VSeparator(),
                        new Label()
                        {
                            Text = ticket.Claimed ? "YES" : "NO",
                            SizeFlagsStretchRatio = 2f,
                            HorizontalExpand = true,
                            ClipText = true,
                        },
                        new TicketTab.VSeparator(),
                        new Label
                        {
                            Text = ticket.Message,
                            SizeFlagsStretchRatio = 2f,
                            HorizontalExpand = true,
                            ClipText = true
                        }
                    }
                };
                TicketList.AddChild(new PanelContainer
                {
                    PanelOverride = new StyleBoxFlat
                    {
                        BackgroundColor = useAltColor ? altColor : defaultColor,
                    },
                    Children =
                    {
                        hBox
                    }
                });
                useAltColor ^= true;
            }
        }

        private static readonly Color SeparatorColor = Color.FromHex("#3D4059");

        private class VSeparator : PanelContainer
        {
            public VSeparator()
            {
                MinSize = (2, 5);
                AddChild(new PanelContainer
                {
                    PanelOverride = new StyleBoxFlat
                    {
                        BackgroundColor = SeparatorColor
                    }
                });
            }
        }

        private class HSeparator : Control
        {
            public HSeparator()
            {
                AddChild(new PanelContainer
                {
                    PanelOverride = new StyleBoxFlat
                    {
                        BackgroundColor = SeparatorColor,
                        ContentMarginBottomOverride = 2, ContentMarginLeftOverride = 2
                    }
                });
            }
        }
    }
}
