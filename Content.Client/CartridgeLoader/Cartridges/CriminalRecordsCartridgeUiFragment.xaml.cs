using Robust.Client.AutoGenerated;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.XAML;
using Content.Shared.CartridgeLoader.Cartridges;
using Content.Shared.CriminalRecords;
using Content.Shared.StationRecords;
using System.Numerics;
using Content.Shared.StatusIcon;
using Robust.Client.GameObjects;
using Robust.Shared.Prototypes;


namespace Content.Client.CartridgeLoader.Cartridges;

[GenerateTypedNameReferences]
public sealed partial class CriminalRecordsCartridgeUiFragment : BoxContainer
{
    [Dependency] private readonly IPrototypeManager _prototypeManager = default!;
    [Dependency] private readonly SpriteSystem _spriteSystem = default!;
    public CriminalRecordsCartridgeUiFragment()
    {
        RobustXamlLoader.Load(this);

        Orientation = LayoutOrientation.Vertical;
        HorizontalExpand = true;
        VerticalExpand = true;

        UpdateState(new CriminalRecordsCartridgeUiState(new List<(GeneralStationRecord, CriminalRecord)>(), new List<(GeneralStationRecord, CriminalRecord)>()));
    }


    public void UpdateState(CriminalRecordsCartridgeUiState state)
    {
        foreach (var (stationRecord, criminalRecord) in state.Wanted)
        {
            AddCriminal(stationRecord, criminalRecord);
        }

        foreach (var (name, record) in state.Detained)
        {
        }
    }

    private void AddCriminal(GeneralStationRecord stationRecord, CriminalRecord criminalRecord)
    {
        var row = new BoxContainer()
        {
            Orientation = LayoutOrientation.Horizontal,
            HorizontalExpand = true,
            Margin = new Thickness(4),
        };

        Wanted.AddChild(row);

        var nameLabel = new Label()
        {
            Text = stationRecord.Name,
            HorizontalExpand = true,
            ClipText = true,
        };

        row.AddChild(nameLabel);

        var jobContainer = new BoxContainer()
        {
            Orientation = LayoutOrientation.Horizontal,
            HorizontalExpand = true,
        };

        row.AddChild(jobContainer);

        var jobLabel = new Label()
        {
            Text = stationRecord.JobTitle,
            HorizontalExpand = true,
            ClipText = true,
        };

        jobContainer.AddChild(jobLabel);

        if (!_prototypeManager.TryIndex<StatusIconPrototype>(
              stationRecord.JobIcon,
              out var proto
              ))
        {
            return;
        }

        var jobIcon = new TextureRect()
        {
            TextureScale = new Vector2(2f, 2f),
            VerticalAlignment = VAlignment.Center,
            Texture = _spriteSystem.Frame0(proto.Icon),
            Margin = new Thickness(5, 0, 5, 0),
        };

        jobContainer.AddChild(jobIcon);
    }

}
