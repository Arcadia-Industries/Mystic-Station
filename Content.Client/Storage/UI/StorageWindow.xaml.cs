using System;
using System.Collections.Generic;
using Content.Client.Items.Components;
using Robust.Client.AutoGenerated;
using Robust.Client.GameObjects;
using Robust.Client.Graphics;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.CustomControls;
using Robust.Shared.GameObjects;
using Robust.Shared.IoC;
using Robust.Shared.Localization;
using Robust.Shared.Maths;
using Robust.Client.UserInterface.XAML;
using Robust.Shared.Utility;
using Robust.Client.Utility;
using Content.Client.Stylesheets;

namespace Content.Client.Storage.UI
{
    [GenerateTypedNameReferences]
    public sealed partial class StorageWindow : SS14Window
    {
        [Dependency] private readonly IEntityManager _entityManager = default!;

        public const float ButtonHeight = 34;
        
        private readonly StyleBoxFlat _hoveredBox = new() { BackgroundColor = Color.Black.WithAlpha(0.35f) };
        private readonly StyleBoxFlat _unHoveredBox = new() { BackgroundColor = Color.Black.WithAlpha(0.0f) };

        private DynamicScrollContainer<EntityUid> _scroll = new()
        {
            ReturnMeasure = true, HorizontalExpand = true, VerticalExpand = true
        };

        private Action<BaseButton.ButtonEventArgs> _onInteract;

        public StorageWindow(Action<BaseButton.ButtonEventArgs> onInteract, Action<BaseButton.ButtonEventArgs> onInsert)
        {
            RobustXamlLoader.Load(this);
            IoCManager.InjectDependencies(this);

            InnerContainerButton.PanelOverride = _unHoveredBox;
            InnerContainerBox.AddChild(_scroll);

            StorageContainerButton.OnPressed += onInsert;
            _scroll.OnMouseEntered += args => InnerContainerButton.PanelOverride = _hoveredBox;
            _scroll.OnMouseExited += args => InnerContainerButton.PanelOverride = _unHoveredBox;
            _scroll.GenerateElementContents = GenerateButton;

            _onInteract = onInteract;
        }

        /// summary>
        /// Loops through stored entities creating buttons for each, updates information labels
        /// </summary>
        public void BuildEntityList(List<EntityUid> entityUids, int storageSizeUsed, int storageCapacityMax)
        {
            List<DynamicScollElement<EntityUid>> elements = new();
            foreach (var uid in entityUids)
            {
                DynamicScollElement<EntityUid> element = new(uid) { SetHeight = ButtonHeight };
                element.OnPressed += _onInteract;
                element.SetOnlyStyleClass(StyleNano.StyleClassStorageButton);
                element.EnableAllKeybinds = true;
                elements.Add(element);
            }
            _scroll.PopulateElements(elements);

            //Sets information about entire storage container current capacity
            if (storageCapacityMax != 0)
                Information.Text = Loc.GetString("comp-storage-window-volume", ("itemCount", entityUids.Count),
                    ("usedVolume", storageSizeUsed), ("maxVolume", storageCapacityMax));
            else
                Information.Text = Loc.GetString("comp-storage-window-volume-unlimited", ("itemCount", entityUids.Count));
        }

        private void GenerateButton(DynamicScollElement<EntityUid> element)
        {
            _entityManager.TryGetComponent(element.Data, out ISpriteComponent? sprite);
            _entityManager.TryGetComponent(element.Data, out ItemComponent? item);
            _entityManager.TryGetComponent(element.Data, out MetaDataComponent? meta);
            
            element.AddChild(new StorageButtonContents(meta?.EntityName ?? string.Empty, sprite, item?.Size ?? 0));
        }
    }
    

    /// <summary>
    /// Button created for each entity that represents that item in the storage UI, with a texture, and name and size label
    /// </summary>
    [GenerateTypedNameReferences]
    public sealed partial class StorageButtonContents : BoxContainer
    {
        private static SpriteSpecifier _weightIcon = new SpriteSpecifier.Texture(new ResourcePath("/Textures/Interface/weight.svg.192dpi.png"));
        
        public StorageButtonContents(string entityName, ISpriteComponent? sprite, int size)
        {
            RobustXamlLoader.Load(this);

            EntityName.Text = entityName;
            EntityView.Sprite = sprite;

            if (size > 0)
            {
                Icon.Visible = true;
                Icon.Texture = _weightIcon.Frame0();
                if (size > 99)
                {
                    EntitySize.Text = "99+";
                    EntitySize.SetOnlyStyleClass(StyleNano.StyleClassStorageWeightLabelSmall);
                }
                else
                {
                    EntitySize.Text = (size > 99) ? "99+" : size.ToString();
                    EntitySize.SetOnlyStyleClass(StyleNano.StyleClassStorageWeightLabel);
                }
            }
        }
    }
}
