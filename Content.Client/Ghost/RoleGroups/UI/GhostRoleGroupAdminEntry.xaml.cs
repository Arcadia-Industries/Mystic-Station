using Content.Shared.Ghost.Roles;
using Robust.Client.AutoGenerated;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.XAML;

namespace Content.Client.Ghost.RoleGroups.UI;

[GenerateTypedNameReferences]
public sealed partial class GhostRoleGroupAdminEntry : BoxContainer
{
    [Dependency] private readonly IEntityManager _entityManager = default!;

    public event Action<AdminGhostRoleGroupInfo>? OnGroupActivate;
    public event Action<AdminGhostRoleGroupInfo>? OnGroupRelease;
    public event Action<AdminGhostRoleGroupInfo>? OnGroupDelete;
    public event Action<EntityUid>? OnEntityGoto;

    private bool _showDetails;

    public GhostRoleGroupAdminEntry(AdminGhostRoleGroupInfo group)
    {
        RobustXamlLoader.Load(this);
        IoCManager.InjectDependencies(this);

        Title.Text = group.Name;
        Description.SetMessage(group.Description);

        foreach (var entity in group.Entities)
        {
            // TODO: Entity might not exist client-side yet :(
            var name = _entityManager.ToPrettyString(entity).Name ?? "Unknown";
            var entry = new GhostRoleGroupEntityEntry(name, entity);

            entry.OnEntityGoto += _ => OnEntityGoto?.Invoke(entity);
            EntityDetailsContainer.AddChild(entry);
            NoRoleGroupEntitiesLabel.Visible = false;
        }

        ActivateButton.Visible = group.Status == GhostRoleGroupStatus.Editing;
        ActivateButton.Text = group.IsActive ? "Deactivate" : "Activate";
        switch (group.IsActive)
        {
            case true:
                ActivateButton.StyleClasses.Add("Caution");
                break;
            case false:
                ActivateButton.StyleClasses.Remove("Caution");
                break;
        }

        ReleaseButton.Disabled = group.Status != GhostRoleGroupStatus.Editing;
        ReleaseButton.Text = group.Status switch
        {
            GhostRoleGroupStatus.Editing => "Release",
            GhostRoleGroupStatus.Releasing => "Releasing...",
            GhostRoleGroupStatus.Released => "Released",
            _ => "Release"
        };

        DeleteButton.Visible = group.Status == GhostRoleGroupStatus.Editing;

        ActivateButton.OnPressed += _ => OnGroupActivate?.Invoke(group);
        ReleaseButton.OnPressed += _ => OnGroupRelease?.Invoke(group);
        DeleteButton.OnPressed += _ => OnGroupDelete?.Invoke(group);
        DetailsButton.OnPressed += _ =>
        {
            _showDetails = !_showDetails;
            EntityDetailsContainer.Visible = _showDetails;
            DetailsButton.Text = _showDetails ? "- Details" : "+ Details";
        };
    }
}
