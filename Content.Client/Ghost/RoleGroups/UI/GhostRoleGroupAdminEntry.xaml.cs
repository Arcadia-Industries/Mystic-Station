using Content.Shared.Ghost.Roles;
using Robust.Client.AutoGenerated;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.XAML;

namespace Content.Client.Ghost.RoleGroups.UI;

[GenerateTypedNameReferences]
public sealed partial class GhostRoleGroupAdminEntry : BoxContainer
{
    [Dependency] private readonly IEntityManager _entityManager = default!;
    [Dependency] private readonly ILocalizationManager _loc = default!;

    public event Action<AdminGhostRoleGroupInfo>? OnGroupActivate;
    public event Action<AdminGhostRoleGroupInfo>? OnGroupRelease;
    public event Action<AdminGhostRoleGroupInfo>? OnGroupDelete;
    public event Action<EntityUid>? OnEntityGoto;

    private bool _showDetails;

    public GhostRoleGroupAdminEntry(AdminGhostRoleGroupInfo group)
    {
        RobustXamlLoader.Load(this);
        IoCManager.InjectDependencies(this);

        Title.Text = group.Name + $" [{group.GroupIdentifier}]";
        Description.SetMessage(group.Description);
        DetailsButton.Text = "+ " + _loc.GetString("ghost-role-groups-window-details-button");

        foreach (var entity in group.Entities)
        {
            // TODO: Entity might not exist client-side yet :(
            var name = _entityManager.ToPrettyString(entity).Name ?? "Unknown";
            var entry = new GhostRoleGroupEntityEntry(name, entity);

            entry.OnEntityGoto += _ => OnEntityGoto?.Invoke(entity);
            EntityDetailsContainer.AddChild(entry);
            NoRoleGroupEntitiesLabel.Visible = false;
        }

        ActivateButton.Visible = group.Status == GhostRoleGroupStatus.Editing;
        ActivateButton.Text = group.IsActive
            ? _loc.GetString("ghost-role-groups-window-deactivate-button")
            : _loc.GetString("ghost-role-groups-window-activate-button");

        switch (group.IsActive)
        {
            case true:
                ActivateButton.StyleClasses.Add("Caution");
                break;
            case false:
                ActivateButton.StyleClasses.Remove("Caution");
                break;
        }

        ReleaseButton.Disabled = group.Status != GhostRoleGroupStatus.Editing;
        ReleaseButton.Text = group.Status switch
        {
            GhostRoleGroupStatus.Editing => _loc.GetString("ghost-role-groups-window-release-button"),
            GhostRoleGroupStatus.Releasing => _loc.GetString("ghost-role-groups-window-releasing-button"),
            GhostRoleGroupStatus.Released => _loc.GetString("ghost-role-groups-window-released-button"),
            _ => _loc.GetString("ghost-role-groups-window-release-button")
        };

        ActivateButton.OnPressed += _ => OnGroupActivate?.Invoke(group);
        ReleaseButton.OnPressed += _ => OnGroupRelease?.Invoke(group);
        DeleteButton.OnPressed += _ => OnGroupDelete?.Invoke(group);
        DetailsButton.OnPressed += _ =>
        {
            _showDetails = !_showDetails;
            EntityDetailsContainer.Visible = _showDetails;

            var prefix = _showDetails ? "- " : "+ ";
            DetailsButton.Text = prefix + _loc.GetString("ghost-role-groups-window-details-button");
        };
    }
}
