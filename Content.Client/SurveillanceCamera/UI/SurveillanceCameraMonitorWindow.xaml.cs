using Content.Client.Viewport;
using Content.Shared.SurveillanceCamera;
using Robust.Client.AutoGenerated;
using Robust.Client.Graphics;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.CustomControls;
using Robust.Client.UserInterface.XAML;

namespace Content.Client.SurveillanceCamera.UI;

[GenerateTypedNameReferences]
public sealed partial class SurveillanceCameraMonitorWindow : DefaultWindow
{
    public event Action<string>? CameraSelected;
    public event Action<string>? SubnetOpened;

    private ScalingViewport? _cameraView;

    public SurveillanceCameraMonitorWindow()
    {
        RobustXamlLoader.Load(this);

        SubnetSelector.OnItemSelected += args =>
        {
            // piss
            SubnetOpened!((string) args.Button.SelectedMetadata!);
        };
    }

    // The UI class should get the eye from the entity, and then
    // pass it here so that the UI can change its view.
    public void UpdateState(IEye? eye, HashSet<string> subnets, string activeSubnet)
    {
        SetCameraView(eye);

        // if the subnet count is unequal, that means
        // we have to rebuild the subnets
        if (SubnetSelector.ItemCount != subnets.Count)
        {
            SubnetSelector.Clear();
            SubnetList.DisposeAllChildren();
            SubnetList.RemoveAllChildren();

            foreach (var subnet in subnets)
            {
                AddSubnet(subnet);
            }
        }

        if (SubnetSelector.SelectedMetadata != null
            && activeSubnet != (string) SubnetSelector.SelectedMetadata)
        {
            for (var i = 0; i < SubnetSelector.ItemCount; i++)
            {
                if ((string) SubnetSelector.GetItemMetadata(i)! == activeSubnet)
                {
                    SubnetList.DisposeAllChildren();
                    SubnetList.RemoveAllChildren();

                    SubnetSelector.Select(i);
                }
            }
        }
    }

    private void SetCameraView(IEye? eye)
    {
        if (eye == null)
        {
            CameraViewBox.DisposeAllChildren();
            CameraViewBox.RemoveAllChildren();
            _cameraView = null;
        }
        else if (_cameraView != null)
        {
            _cameraView.Eye = eye;
        }
        else
        {
            _cameraView = new()
            {
                Eye = eye,
                MouseFilter = MouseFilterMode.Ignore
            };
        }
    }

    private int AddSubnet(string subnet)
    {
        SubnetSelector.AddItem(subnet);
        SubnetSelector.SetItemMetadata(SubnetSelector.ItemCount - 1, subnet);

        return SubnetSelector.ItemCount - 1;
    }

    public void AddCameraToList(string name, string address)
    {
        var button = CreateCameraButton(name, address);
        SubnetList.AddChild(button);
    }

    private Button CreateCameraButton(string name, string address)
    {
        var button = new Button()
        {
            Text = name
        };

        button.OnPressed += _ => CameraSelected!(address);

        return button;
    }
}
