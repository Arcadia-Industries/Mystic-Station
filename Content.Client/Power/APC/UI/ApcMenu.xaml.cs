using Robust.Client.AutoGenerated;
using Robust.Client.UserInterface.XAML;
using Content.Shared.APC;
using Robust.Client.Graphics;
using FancyWindow = Content.Client.UserInterface.Controls.FancyWindow;
using Content.Client.Power.PowerMonitoring;
using Content.Shared.Access.Components;
using Content.Shared.Access.Systems;
using Robust.Client.Player;

namespace Content.Client.Power.APC.UI
{
    [GenerateTypedNameReferences]
    public sealed partial class ApcMenu : FancyWindow
    {
        [Dependency] private readonly EntityManager _entityManager = default!;
        [Dependency] private readonly IPlayerManager _playerManager = default!;
        private readonly AccessReaderSystem? _accessReader = default!;
        private readonly PowerMonitoringSystem? _powerMonitoring = default!;

        private NetEntity _owner;

        public ApcMenu(ApcBoundUserInterface owner)
        {
            IoCManager.InjectDependencies(this);
            RobustXamlLoader.Load(this);

            _entityManager.TrySystem(out _accessReader);
            _entityManager.TrySystem(out _powerMonitoring);

            EntityView.SetEntity(owner.Owner);
            BreakerButton.OnPressed += _ => owner.BreakerPressed();
            _owner = _entityManager.GetNetEntity(owner.Owner);

            if (_entityManager.TryGetComponent<MetaDataComponent>(owner.Owner, out var meta))
                Title = meta.EntityName;
        }

        public void UpdateState(ApcBoundInterfaceState state)
        {
            bool hasAccess = _playerManager.LocalPlayer?.ControlledEntity != null &&
                _accessReader != null &&
                _accessReader.IsAllowed(_playerManager.LocalPlayer.ControlledEntity.Value, _entityManager.GetEntity(_owner));

            if (BreakerButton != null)
            {
                BreakerButton.Disabled = !hasAccess;
                BreakerButton.ToolTip = !hasAccess ? Loc.GetString("apc-component-insufficient-access") : null;
                BreakerButton.Pressed = state.MainBreaker;
            }

            if (PowerLabel != null)
                PowerLabel.Text = Loc.GetString("power-monitoring-window-value", ("value", state.Power));

            if (_powerMonitoring == null)
                return;

            if (ExternalPowerStateLabel != null)
                _powerMonitoring.UpdateExternalPowerStateLabel(ExternalPowerStateLabel, state.ExternalPower);

            if (ChargeBar != null)
            {
                ChargeBar.Value = state.Charge;
                _powerMonitoring.UpdateChargeBarColor(ChargeBar, state.Charge);
                var chargePercentage = state.Charge / ChargeBar.MaxValue;
                ChargePercentage.Text = Loc.GetString("power-monitoring-window-charge-label", ("percent", chargePercentage.ToString("P0")));
            }
        }
    }
}
