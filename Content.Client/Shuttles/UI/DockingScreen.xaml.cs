using Content.Shared.Shuttles.BUIStates;
using Robust.Client.AutoGenerated;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.XAML;
using Robust.Shared.Map;

namespace Content.Client.Shuttles.UI;

[GenerateTypedNameReferences]
public sealed partial class DockingScreen : BoxContainer
{
    [Dependency] private readonly IEntityManager _entManager = default!;

    /// <summary>
    /// Stored by GridID then by docks
    /// </summary>
    public Dictionary<NetEntity, List<DockingPortState>> Docks = new();

    public DockingScreen()
    {
        RobustXamlLoader.Load(this);
        IoCManager.InjectDependencies(this);
    }

    public void UpdateState(EntityUid? shuttle, DockingInterfaceState state)
    {
        Docks = state.Docks;
        DockingControl.DockState = state;
        DockingControl.GridEntity = shuttle;
        BuildDocks(shuttle);
    }

    private void BuildDocks(EntityUid? shuttle)
    {
        var currentDock = DockingControl.ViewedDock;

        DockPorts.DisposeAllChildren();

        if (shuttle == null)
        {
            DockingControl.ViewedDock = null;
            return;
        }

        var shuttleNent = _entManager.GetNetEntity(shuttle.Value);

        if (Docks.TryGetValue(shuttleNent, out var shuttleDocks))
        {
            var buttonGroup = new ButtonGroup();

            foreach (var dock in shuttleDocks)
            {
                var button = new Button()
                {
                    Text = "dock 1",
                    ToggleMode = true,
                    Group = buttonGroup,
                };

                if (currentDock == dock.Entity)
                {
                    button.Pressed = true;
                }

                button.OnPressed += args =>
                {
                    OnDockPress(args, dock.Entity, dock.Coordinates, dock.Angle);
                };

                DockPorts.AddChild(button);
            }
        }
    }

    private void OnDockPress(BaseButton.ButtonEventArgs args, NetEntity entity, NetCoordinates? coordinates, Angle angle)
    {
        DockingControl.ViewedDock = entity;
        DockingControl.Coordinates = _entManager.GetCoordinates(coordinates);
        DockingControl.Angle = angle;
    }
}
