using System.Numerics;
using Content.Shared.Shuttles.BUIStates;
using Content.Shared.Shuttles.Components;
using Content.Shared.Shuttles.Systems;
using Robust.Client.AutoGenerated;
using Robust.Client.Graphics;
using Robust.Client.UserInterface;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.XAML;
using Robust.Shared.Map;
using Robust.Shared.Map.Components;
using Robust.Shared.Timing;

namespace Content.Client.Shuttles.UI;

[GenerateTypedNameReferences]
public sealed partial class MapScreen : BoxContainer
{
    [Dependency] private readonly IEntityManager _entManager = default!;
    [Dependency] private readonly IGameTiming _timing = default!;
    [Dependency] private readonly IMapManager _mapManager = default!;
    private readonly SharedMapSystem _maps;
    private readonly SharedTransformSystem _xformSystem;

    private EntityUid? _shuttleEntity;

    private FTLState _state;
    private float _ftlDuration;

    /// <summary>
    /// When the next FTL state change happens.
    /// </summary>
    private TimeSpan _nextFtlTime;

    private StyleBoxFlat _ftlStyle;

    public event Action<MapCoordinates, Angle>? RequestFTL;
    public event Action<NetEntity, Angle>? RequestBeaconFTL;

    public MapScreen()
    {
        RobustXamlLoader.Load(this);
        IoCManager.InjectDependencies(this);

        _maps = _entManager.System<SharedMapSystem>();
        _xformSystem = _entManager.System<SharedTransformSystem>();

        MapRebuildButton.OnPressed += MapRebuildPressed;

        OnVisibilityChanged += OnVisChange;

        MapFTLButton.OnToggled += FtlPreviewToggled;

        _ftlStyle = new StyleBoxFlat(Color.LimeGreen);
        FTLBar.ForegroundStyleBoxOverride = _ftlStyle;

        // Just pass it on up.
        MapRadar.RequestFTL += (coords, angle) =>
        {
            RequestFTL?.Invoke(coords, angle);
        };

        MapRadar.RequestBeaconFTL += (ent, angle) =>
        {
            RequestBeaconFTL?.Invoke(ent, angle);
        };
    }

    public void UpdateState(ShuttleMapInterfaceState state)
    {
        // Only network the accumulator due to ping making the thing fonky.
        // This should work better with predicting network states as they come in.
        _state = state.FTLState;
        _ftlDuration = state.FTLDuration;
        _nextFtlTime = _timing.CurTime + TimeSpan.FromSeconds(_ftlDuration);
        MapRadar.InFtl = true;
        MapFTLState.Text = Loc.GetString($"shuttle-console-ftl-state-{_state.ToString()}");

        switch (_state)
        {
            case FTLState.Available:
                _ftlStyle.BackgroundColor = Color.FromHex("#80C71F");
                MapRadar.InFtl = false;
                break;
            case FTLState.Starting:
                _ftlStyle.BackgroundColor = Color.FromHex("#169C9C");
                break;
            case FTLState.Travelling:
                _ftlStyle.BackgroundColor = Color.FromHex("#8932B8");
                break;
            case FTLState.Arriving:
                _ftlStyle.BackgroundColor = Color.FromHex("#F9801D");
                break;
            case FTLState.Cooldown:
                // Scroll to the FTL spot
                if (_entManager.TryGetComponent(_shuttleEntity, out TransformComponent? shuttleXform))
                {
                    var targetOffset = _maps.GetGridPosition(_shuttleEntity.Value);
                    MapRadar.SetMap(shuttleXform.MapID, targetOffset, recentering: true);
                }

                _ftlStyle.BackgroundColor = Color.FromHex("#B02E26");
                MapRadar.InFtl = false;
                break;
            default:
                throw new NotImplementedException();
        }

        MapRadar.UpdateState(state);
    }

    private void FtlPreviewToggled(BaseButton.ButtonToggledEventArgs obj)
    {
        MapRadar.FtlMode = obj.Pressed;
    }

    public void SetShuttle(EntityUid? shuttle)
    {
        _shuttleEntity = shuttle;
        MapRadar.SetShuttle(shuttle);
    }

    private void OnVisChange(Control obj)
    {
        if (obj.Visible)
        {
            // Centre map screen to the shuttle.
            if (_shuttleEntity != null)
            {
                var mapPos = _xformSystem.GetMapCoordinates(_shuttleEntity.Value);
                MapRadar.SetMap(mapPos.MapId, mapPos.Position);
            }

            BuildMapObjects();
        }
    }

    private void MapRebuildPressed(BaseButton.ButtonEventArgs obj)
    {
        BuildMapObjects();
    }

    private void BuildMapObjects()
    {
        HyperspaceDestinations.DisposeAllChildren();

        if (_shuttleEntity == null)
            return;

        var mapComps = _entManager.AllEntityQueryEnumerator<MapComponent, TransformComponent, MetaDataComponent>();
        MapId ourMap = MapId.Nullspace;
        var destQuery = _entManager.GetEntityQuery<FTLDestinationComponent>();

        if (_entManager.TryGetComponent(_shuttleEntity, out TransformComponent? shuttleXform))
        {
            ourMap = shuttleXform.MapID;
        }

        while (mapComps.MoveNext(out var mapUid, out var mapComp, out var mapXform, out var mapMetadata))
        {
            // If it's our map OR a valid FTL destination then show it
            if (ourMap != mapXform.MapID &&
                (!destQuery.TryGetComponent(mapUid, out var mapDest) ||
                 mapDest.Whitelist?.IsValid(_shuttleEntity.Value, _entManager) == false))
            {
                continue;
            }

            var mapName = mapMetadata.EntityName;

            if (string.IsNullOrEmpty(mapName))
            {
                mapName = Loc.GetString("shuttle-console-unknown-map");
            }

            var heading = new CollapsibleHeading(mapName);

            heading.MinHeight = 32f;
            heading.AddStyleClass(ContainerButton.StyleClassButton);
            heading.HorizontalAlignment = HAlignment.Stretch;
            heading.Label.HorizontalAlignment = HAlignment.Center;
            heading.Label.HorizontalExpand = true;
            heading.HorizontalExpand = true;

            var gridContents = new BoxContainer()
            {
                Orientation = LayoutOrientation.Vertical,
                VerticalExpand = true,
            };

            var body = new CollapsibleBody()
            {
                HorizontalAlignment = HAlignment.Stretch,
                VerticalAlignment = VAlignment.Top,
                HorizontalExpand = true,
                Children =
                {
                    gridContents
                }
            };

            var mapButton = new Collapsible(heading, body);

            heading.OnToggled += args =>
            {
                if (args.Pressed)
                {
                    HideOtherCollapsibles(mapButton);
                }
            };

            foreach (var grid in _mapManager.GetAllMapGrids(mapComp.MapId))
            {
                var gridButton = new Button()
                {
                    Text = _entManager.GetComponent<MetaDataComponent>(grid.Owner).EntityName,
                    HorizontalExpand = true,
                    MinHeight = 32f,
                };

                var gridContainer = new BoxContainer()
                {
                    Children =
                    {
                        new Control()
                        {
                            MinWidth = 32f,
                        },
                        gridButton
                    }
                };

                gridContents.AddChild(gridContainer);

                gridButton.OnPressed += args =>
                {
                    OnGridPress(grid.Owner);
                };
            }

            HyperspaceDestinations.AddChild(mapButton);

            // Zoom in to our map
            if (mapComp.MapId == MapRadar.ViewingMap)
            {
                mapButton.BodyVisible = true;
            }
        }
    }

    private void HideOtherCollapsibles(Collapsible collapsible)
    {
        foreach (var child in HyperspaceDestinations.Children)
        {
            if (child is not Collapsible childCollapse || childCollapse == collapsible)
                continue;

            childCollapse.BodyVisible = false;
        }
    }

    private void OnGridPress(EntityUid gridUid)
    {
        switch (_state)
        {
            case FTLState.Available:
                break;
            case FTLState.Cooldown:
                break;
            default:
                return;
        }

        var gridXform = _entManager.GetComponent<TransformComponent>(gridUid);
        var mapPos = _maps.GetGridPosition((gridUid, null, gridXform));

        // If it's our map then scroll, otherwise just set position there.
        MapRadar.SetMap(gridXform.MapID, mapPos, recentering: true);
    }

    public void SetMap(MapId mapId, Vector2 position)
    {
        MapRadar.SetMap(mapId, position);
        MapRadar.Offset = position;
    }

    protected override void FrameUpdate(FrameEventArgs args)
    {
        base.FrameUpdate(args);

        var ftlDiff = (float) (_nextFtlTime - _timing.CurTime).TotalSeconds;

        float ftlRatio;

        if (_ftlDuration.Equals(0f))
        {
            ftlRatio = 1f;
        }
        else
        {
            ftlRatio = Math.Clamp(1f - (ftlDiff / _ftlDuration), 0f, 1f);
        }

        FTLBar.Value = ftlRatio;
    }

    public void Startup()
    {
        if (_entManager.TryGetComponent(_shuttleEntity, out TransformComponent? shuttleXform))
        {
            SetMap(shuttleXform.MapID, _maps.GetGridPosition((_shuttleEntity.Value, null, shuttleXform)));
        }
    }
}
