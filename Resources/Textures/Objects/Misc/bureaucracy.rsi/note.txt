TODO: Someone needs to split this up at some point. This RSI is a mess.