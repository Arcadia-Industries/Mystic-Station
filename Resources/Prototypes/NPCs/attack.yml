# -- Ranged --
- type: htnCompound
  id: TurretCompound
  desc: Tries to shoot a target in LOS in range.
  branches:
    - tasks:
        - id: PickRangedTargetPrimitive
        - id: RangedAttackTargetPrimitive

- type: htnCompound
  id: RangedCombatCompound
  desc: Tries to shoot a target at range.
  branches:
    - tasks:
        - id: PickRangedTargetPrimitive
        - id: RangedAttackTargetCompound

- type: htnCompound
  id: RangedAttackTargetCompound
  desc: Tries to ranged attack our target.
  preconditions:
    - !type:KeyExistsPrecondition
      key: CombatTarget
  branches:
    # Keep hitting them if they're in LOS
    - tasks:
        - id: RangedAttackTargetPrimitive

    # Move to range and hit them
    - tasks:
        - id: MoveToCombatTargetPrimitive
        - id: RangedAttackTargetPrimitive


- type: htnPrimitive
  id: PickRangedTargetPrimitive
  operator: !type:PickRangedTargetOperator

- type: htnPrimitive
  id: RangedAttackTargetPrimitive
  desc: Attacks the specified target if they're in LOS.
  operator: !type:RangedOperator
    targetKey: CombatTarget
  preconditions:
    - !type:KeyExistsPrecondition
      key: CombatTarget
    - !type:TargetInRangePrecondition
      targetKey: CombatTarget
      # TODO: Non-scuffed
      rangeKey: RangedRange
    - !type:TargetInLOSPrecondition
      targetKey: CombatTarget
      rangeKey: RangedRange


# -- Melee --
- type: htnCompound
  id: MeleeCombatCompound
  desc: Selects a target in melee and tries to attack it.
  branches:
    # Unarmed combat
    - tasks:
        - id: PickMeleeTargetPrimitive
        - id: MeleeAttackTargetCompound

- type: htnCompound
  id: MeleeAttackTargetCompound
  desc: Tries to melee attack our target.
  preconditions:
    - !type:KeyExistsPrecondition
      key: CombatTarget
  branches:
    # Keep hitting them if they're in range
    - tasks:
        - id: MeleeAttackTargetPrimitive

    # Move to melee range and hit them
    - tasks:
        - id: MoveToCombatTargetPrimitive
        - id: MeleeAttackTargetPrimitive


- type: htnPrimitive
  id: PickMeleeTargetPrimitive
  operator: !type:PickMeleeTargetOperator

- type: htnPrimitive
  id: MeleeAttackTargetPrimitive
  desc: Attacks the specified target if they're in range.
  operator: !type:MeleeOperator
    targetKey: CombatTarget
  preconditions:
    - !type:KeyExistsPrecondition
      key: CombatTarget
    - !type:TargetInRangePrecondition
      targetKey: CombatTarget
      rangeKey: MeleeRange

- type: htnPrimitive
  id: MoveToCombatTargetPrimitive
  desc: Moves the owner into range of the combat target.
  operator: !type:MoveToOperator
    pathfindInPlanning: true
    removeKeyOnFinish: false
    targetKey: CombatTargetCoordinates
    pathfindKey: CombatTargetPathfind
    rangeKey: MeleeRange
