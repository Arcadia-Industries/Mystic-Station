# -- Melee --
# Selects a target in melee and tries to attack it.
- type: htnCompound
  id: MeleeCombatCompound
  branches:
    # Unarmed combat
    - tasks:
        - id: PickMeleeTargetPrimitive
        - id: MeleeAttackTargetCompound

# Tries to melee attack our target.
- type: htnCompound
  id: MeleeAttackTargetCompound
  preconditions:
    - !type:KeyExistsPrecondition
      key: Target
  branches:
    # Keep hitting them if they're in range
    - tasks:
        - id: MeleeAttackTargetPrimitive

    # Move to melee range and hit them
    - tasks:
        - id: MoveToCombatTargetPrimitive
        - id: MeleeAttackTargetPrimitive

# Primitive
- type: htnPrimitive
  id: PickMeleeTargetPrimitive
  operator: !type:UtilityOperator
    proto: NearbyMeleeTargets

# Attacks the specified target if they're in range.
- type: htnPrimitive
  id: MeleeAttackTargetPrimitive
  operator: !type:MeleeOperator
    targetKey: Target
  preconditions:
    - !type:KeyExistsPrecondition
      key: Target
    - !type:TargetInRangePrecondition
      targetKey: Target
      rangeKey: MeleeRange
  services:
    - !type:UtilityService
      id: MeleeService
      proto: NearbyMeleeTargets
      key: Target

# Moves the owner into range of the combat target.
- type: htnPrimitive
  id: MoveToCombatTargetPrimitive
  operator: !type:MoveToOperator
    pathfindInPlanning: true
    removeKeyOnFinish: false
    targetKey: TargetCoordinates
    pathfindKey: TargetPathfind
    rangeKey: MeleeRange
